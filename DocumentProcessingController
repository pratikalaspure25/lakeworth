public class DocumentProcessingController {
    
    @AuraEnabled
    public static String processFile(String contentDocumentId) {
        try {
            // Step 1: Initiate OCR extraction
            String extractedText = initiateOCR(contentDocumentId);
            
            // Step 2: Save the extracted text into Profit_and_Loss__c record
            saveExtractedTextToRecord(extractedText);
            
            return 'Text extraction and record creation successful';
        } catch (Exception e) {
            return 'Error processing the document: ' + e.getMessage();
        }
    }
    
  private static String initiateOCR(String contentDocumentId) {
    // Step 1: Get the content document (ContentVersion)
    ContentDocument contentDoc = [SELECT Id, Title FROM ContentDocument WHERE Id = :contentDocumentId LIMIT 1];
    
    // Step 2: Get the ContentVersion for the file
    ContentVersion contentVersion = [SELECT Id, Title, VersionData FROM ContentVersion WHERE ContentDocumentId = :contentDoc.Id LIMIT 1];
    
    // Step 3: Convert the document data into a format suitable for the IDR API call
    Blob documentBlob = contentVersion.VersionData;
    
    // Step 4: Create a document object for extraction
    Idr.Document document = new Idr.Document();
    document.setContent(documentBlob);
    
    // Step 5: Set the OCR template to use (example)
    String ocrTemplateId = 'PL_Template'; // Replace with your actual template ID
    document.setTemplateId(ocrTemplateId);

    // Step 6: Call the IDR API to extract text from the document
    Idr.ExtractedData extractedData = document.extract();
    
    // Step 7: Log the structure of the extractedData object
    System.debug('Extracted Data: ' + extractedData);

    // Step 8: Ensure keyValuePairs exist and loop over them if available
    String extractedText = '';
    if (extractedData != null && extractedData.keyValuePairs != null) {
        for (Idr.KeyValue keyValue : extractedData.keyValuePairs) {
            // Debugging key and value for each key-value pair
            System.debug('Key: ' + keyValue.getKey() + ' Value: ' + keyValue.getValue());
            extractedText += keyValue.getKey() + ': ' + keyValue.getValue() + '\n';
        }
    } else {
        // If keyValuePairs are not found, log an error
        System.debug('No key-value pairs found in the extracted data.');
        extractedText = 'No extracted text found in the document.';
    }

    return extractedText;
}



    private static void saveExtractedTextToRecord(String extractedText) {
        // Create a new Profit_and_Loss__c record and save the extracted text
        Profit_and_Loss__c record = new Profit_and_Loss__c();
        
        // Populate the record with extracted data
        record.Name = 'Profit and Loss Statement';
        record.Extracted_Text__c = extractedText;  // Assuming a custom field for extracted text
        record.Loan_Number__c = '093384';  // Example: Loan Number extracted from the document
        
        // Insert the record into Salesforce
        insert record;
    }
}
