public class DocumentProcessingController {
    
    @AuraEnabled
    public static String processFile(String contentDocumentId) {
        try {
            // Step 1: Initiate OCR extraction
            String extractedText = initiateOCR(contentDocumentId);
            
            // Step 2: Save the extracted text into Profit_and_Loss__c record
            saveExtractedTextToRecord(extractedText);
            
            return 'Text extraction and record creation successful';
        } catch (Exception e) {
            return 'Error processing the document: ' + e.getMessage();
        }
    }
    
   private static String initiateOCR(String contentDocumentId) {
    // Step 1: Get the content document (ContentVersion)
    ContentDocument contentDoc = [SELECT Id, Title FROM ContentDocument WHERE Id = :contentDocumentId LIMIT 1];
    
    // Step 2: Get the ContentVersion for the file
    ContentVersion contentVersion = [SELECT Id, Title, VersionData FROM ContentVersion WHERE ContentDocumentId = :contentDoc.Id LIMIT 1];
    
    // Step 3: Convert the document data into a format suitable for the IDR API call
    Blob documentBlob = contentVersion.VersionData;
    
    // Step 4: Create a document object for extraction
    Idr.Document document = new Idr.Document();
    document.setContent(documentBlob);
    
    // Step 5: Set the OCR template to use (example)
    String ocrTemplateId = 'PL_Template'; // This is your OCR template's ID (replace with the actual template ID)
    document.setTemplateId(ocrTemplateId);

    // Step 6: Call the IDR API to extract text from the document
    Idr.ExtractedData extractedData = document.extract();
    
    // Step 7: Ensure we are getting the keyValuePairs from the extracted data
    if (extractedData != null && extractedData.keyValuePairs != null) {
        // Step 8: Extract the data and format it into a string
        String extractedText = '';
        
        // Loop through the key-value pairs and build the extracted text string
        for (Idr.KeyValue keyValue : extractedData.keyValuePairs) {
            // Debugging the key-value pair extraction
            System.debug('Key: ' + keyValue.getKey() + ', Value: ' + keyValue.getValue());
            
            // Add the key-value pair to the extracted text
            extractedText += keyValue.getKey() + ': ' + keyValue.getValue() + '\n';
        }
        
        return extractedText;
    } else {
        // If no key-value pairs are found, return an error message
        return 'No extracted text found in the document.';
    }
}



    private static void saveExtractedTextToRecord(String extractedText) {
        // Create a new Profit_and_Loss__c record and save the extracted text
        Profit_and_Loss__c record = new Profit_and_Loss__c();
        
        // Populate the record with extracted data
        record.Name = 'Profit and Loss Statement';
        record.Extracted_Text__c = extractedText;  // Assuming a custom field for extracted text
        record.Loan_Number__c = '093384';  // Example: Loan Number extracted from the document
        
        // Insert the record into Salesforce
        insert record;
    }
}
