public class ProcessDocumentJob implements Queueable, Database.AllowsCallouts {
    private String contentDocumentId;
    private String recordId;
    private Integer retryCount;
    private static final Integer MAX_RETRIES = 10;

    public ProcessDocumentJob(String contentDocumentId, String recordId) {
        this(contentDocumentId, recordId, 0);
    }
    
    private ProcessDocumentJob(String contentDocumentId, String recordId, Integer retryCount) {
        this.contentDocumentId = contentDocumentId;
        this.recordId = recordId;
        this.retryCount = retryCount;
    }

    public void execute(QueueableContext context) {
        try {
            ContentVersion cv = [SELECT Id, Title, VersionData FROM ContentVersion WHERE ContentDocumentId = :contentDocumentId LIMIT 1];
            if (cv == null) {
                System.debug('No ContentVersion found for ContentDocumentId: ' + contentDocumentId);
                return;
            }

            // First time: Trigger OCR processing
            if (retryCount == 0) {
                String initResult = triggerOcrProcessing(cv.VersionData);
                if(String.isBlank(initResult)){
                    System.debug('OCR initialization failed.');
                    return;
                }
            }
            
            // Check status and handle retries
            String status = checkOCRStatus();
            System.debug('Current OCR Status: ' + status);
            
            if (status == 'OCR_ENQUEUE' && retryCount < MAX_RETRIES) {
                // Schedule next retry
                ProcessDocumentJob retryJob = new ProcessDocumentJob(contentDocumentId, recordId, retryCount + 1);
                System.enqueueJob(retryJob, 5); // 5 second delay
                return;
            } else if (status == 'Success') {
                // Process the results
                String extractedText = fetchExtractedText(null, contentDocumentId); // Pass null for ocrResultId as we'll get it from status
                if (String.isNotBlank(extractedText)) {
                    insertNewProfitAndLossRecord(extractedText);
                }
            } else if (retryCount >= MAX_RETRIES) {
                System.debug('Max retries exceeded. Last status: ' + status);
            }

        } catch (Exception e) {
            System.debug('Error processing document: ' + e.getMessage());
        }
    }

    private String checkOCRStatus() {
        Http http = new Http();
        HttpRequest request = new HttpRequest();
        String endpointUrl = '/services/data/v58.0/actions/standard/fetchExtractedText';

        String requestBody = JSON.serialize(new Map<String, Object>{
            'inputs' => new List<Map<String, Object>>{
                new Map<String, Object>{
                    'contentDocumentId' => contentDocumentId,
                    'startPageIndex' => 1,
                    'endPageIndex' => 20
                }
            }
        });

        request.setEndpoint(URL.getOrgDomainUrl().toExternalForm() + endpointUrl);
        request.setMethod('POST');
        request.setHeader('Content-Type', 'application/json');
        request.setHeader('Authorization', 'Bearer ' + UserInfo.getSessionId());
        request.setBody(requestBody);

        HttpResponse response = http.send(request);
        
        if (response.getStatusCode() == 200) {
            List<Object> responseList = (List<Object>) JSON.deserializeUntyped(response.getBody());
            if (responseList != null && !responseList.isEmpty()) {
                Map<String, Object> firstResult = (Map<String, Object>) responseList[0];
                if (firstResult.containsKey('outputValues')) {
                    Map<String, Object> outputValues = (Map<String, Object>) firstResult.get('outputValues');
                    if (outputValues.containsKey('ocrDocumentScanResultDetails')) {
                        Map<String, Object> details = (Map<String, Object>) outputValues.get('ocrDocumentScanResultDetails');
                        if (details.containsKey('status')) {
                            return (String)details.get('status');
                        }
                    }
                }
            }
        }
        return 'Unknown';
    }

      // This method performs HTTP callout to the OCR API to trigger text extraction
private String triggerOcrProcessing(Blob documentData) {
   // try {
        Http http = new Http();
        HttpRequest request = new HttpRequest();

        // Salesforce REST API endpoint to initiate text extraction
        String endpointUrl = '/services/data/v58.0/actions/standard/initiateTextExtraction';

        // Prepare the request body as a JSON string
        String requestBody = JSON.serialize(new Map<String, Object>{
            'inputs' => new List<Map<String, Object>>{
                new Map<String, Object>{
                    'contentDocumentId' => contentDocumentId,  // Your uploaded document ID
                    'startPageIndex' => 1,  // Start from page 1
                    'endPageIndex' => 20,  // You can change this based on how many pages you want to extract
                    'ocrService' => 'AMAZON_TEXTRACT'  // Using the Textract OCR service
                }
            }
        });

        // Set up the HTTP request
        request.setEndpoint(URL.getOrgDomainUrl().toExternalForm() + endpointUrl);  // Combine Salesforce base URL with the endpoint
        request.setMethod('POST');
        request.setHeader('Content-Type', 'application/json');
        request.setHeader('Authorization', 'Bearer ' + UserInfo.getSessionId());  // Use the session ID for authorization
        request.setBody(requestBody);

        // Send the HTTP request
        HttpResponse response = http.send(request);

        // Log the response body for debugging
        System.debug('OCR API response: ' + response.getBody());

        // Handle the response
        if (response.getStatusCode() == 200) {
            // Deserialize the response body into a List of Maps (List<Map<String, Object>>)
            List<Object> responseList = (List<Object>) JSON.deserializeUntyped(response.getBody());

            // Check if the response is not empty
            if (responseList != null && !responseList.isEmpty()) {
                // Get the first item in the response list
                Map<String, Object> resultMap = (Map<String, Object>) responseList[0];

                // Check if outputValues exists in the result map
                if (resultMap.containsKey('outputValues')) {
                    Map<String, Object> outputValues = (Map<String, Object>) resultMap.get('outputValues');

                    if (outputValues.containsKey('ocrDocumentScanResultDetails')) {
                        // Extract the OCR document scan result details
                        Map<String, Object> ocrDocumentScanResultDetails = (Map<String, Object>) outputValues.get('ocrDocumentScanResultDetails');

                        if (ocrDocumentScanResultDetails.containsKey('ocrDocumentScanResults')) {
                            // Extract the OCR results
                            List<Object> ocrResults = (List<Object>) ocrDocumentScanResultDetails.get('ocrDocumentScanResults');

                            // Iterate over the results and extract the OCR result ID
                            for (Object ocrResultObj : ocrResults) {
                                // Cast the object to a map for easier access to the ocrResultId
                                Map<String, Object> ocrResult = (Map<String, Object>) ocrResultObj;
                                String ocrResultId = (String) ocrResult.get('ocrDocumentScanResultId');
                                System.debug('OCR Result ID: ' + ocrResultId);

                                // Fetch the extracted text now
                               String extractedText = fetchExtractedText(ocrResultId, contentDocumentId);
                                System.debug('Extracted Text: ' + extractedText);
                            }
                        }
                    }
                }
            } else {
                System.debug('Unexpected or empty response: ' + response.getBody());
                return 'No OCR results found'; // Provide a meaningful string in case of an empty response
            }
        } else {
            System.debug('Error calling OCR API, status: ' + response.getStatus() + ', body: ' + response.getBody());
            return 'Error calling OCR API'; // Return a string indicating failure
        }

        return 'OCR processing completed successfully'; // Return a success message if all goes well
    // } catch (Exception ex) {
    //     System.debug('Exception during OCR processing: ' + ex.getMessage());
    //     return 'Exception during OCR processing: ' + ex.getMessage(); // Return the exception message
    // }
}

    // Modify fetchExtractedText to handle the status check
    private String fetchExtractedText(String ocrDocumentScanResultId, String contentDocumentId) {
        Http http = new Http();
        HttpRequest request = new HttpRequest();
        String endpointUrl = '/services/data/v58.0/actions/standard/fetchExtractedText';

        String requestBody = JSON.serialize(new Map<String, Object>{
            'inputs' => new List<Map<String, Object>>{
                new Map<String, Object>{
                    'contentDocumentId' => contentDocumentId,
                    'startPageIndex' => 1,
                    'endPageIndex' => 20
                }
            }
        });

        request.setEndpoint(URL.getOrgDomainUrl().toExternalForm() + endpointUrl);
        request.setMethod('POST');
        request.setHeader('Content-Type', 'application/json');
        request.setHeader('Authorization', 'Bearer ' + UserInfo.getSessionId());
        request.setBody(requestBody);

        HttpResponse response = http.send(request);
        System.debug('Extracted Text API response: ' + response.getBody());

        if (response.getStatusCode() == 200) {
            List<Object> responseList = (List<Object>) JSON.deserializeUntyped(response.getBody());
            if (responseList != null && !responseList.isEmpty()) {
                Map<String, Object> firstResult = (Map<String, Object>) responseList[0];
                if (firstResult.containsKey('outputValues')) {
                    Map<String, Object> outputValues = (Map<String, Object>) firstResult.get('outputValues');
                    if (outputValues.containsKey('ocrDocumentScanResultDetails')) {
                        Map<String, Object> details = (Map<String, Object>) outputValues.get('ocrDocumentScanResultDetails');
                        
                        // Check if we have actual results
                        if (details.containsKey('ocrDocumentScanResults')) {
                            List<Object> results = (List<Object>)details.get('ocrDocumentScanResults');
                            if (!results.isEmpty()) {
                                Map<String, Object> result = (Map<String, Object>)results[0];
                                if (result.containsKey('extractedText')) {
                                    return (String)result.get('extractedText');
                                }
                            }
                        }
                        return JSON.serialize(details);
                    }
                }
            }
        }
        return null;
    }

     private void insertNewProfitAndLossRecord(String ocrResult) {
        try {
            Profit_and_Loss__c newRecord = new Profit_and_Loss__c();
// Deserialize the response as a Map<String, Object>
Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(ocrResult);

// Check if 'ocrDocumentScanResultDetails' is present and handle the list inside it
if (responseMap.containsKey('ocrDocumentScanResultDetails')) {
    List<Map<String, Object>> ocrDetailsList = (List<Map<String, Object>>) responseMap.get('ocrDocumentScanResultDetails');
    
    // Process each item in the list
    for (Map<String, Object> ocrDetail : ocrDetailsList) {
        // Process the OCR details
        System.debug('OCR Detail: ' + ocrDetail);
    }
} else {
    System.debug('No OCR details found in the response.');
}

            // Optionally associate with a related record passed in the job
            // if(recordId != null) {
            //     // Assuming you have a lookup field to associate
            //     newRecord.Related_Record__c = recordId;
            // }

            insert newRecord;
            System.debug('Inserted Profit_and_Loss__c record with Id: ' + newRecord.Id);

        } catch(Exception ex){
            System.debug('Failed to insert Profit_and_Loss__c record: ' + ex.getMessage());
        }
    }
}
