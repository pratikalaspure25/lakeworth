public class IdentificationSaverJob implements Queueable {
    private String rawJson;
    private Id     recordId;
    private String docName;

    public IdentificationSaverJob(String rawJson, Id recordId, String docName) {
        this.rawJson  = rawJson;
        this.recordId = recordId;
        this.docName  = docName;
    }

    public void execute(QueueableContext ctx) {
        // 1) No payload at all
        if (String.isBlank(rawJson)) {
            postProcessingFailed();
            return;
        }

        // 2) Top-level array
        List<Object> wrapperList = (List<Object>) JSON.deserializeUntyped(rawJson);
        if (wrapperList.isEmpty()) {
            postProcessingFailed();
            return;
        }

        // 3) Drill into the first action’s outputValues
        Map<String, Object> actionResp   = (Map<String, Object>) wrapperList[0];
        Map<String, Object> outputValues = (Map<String, Object>) actionResp.get('outputValues');
        if (outputValues == null
         || !outputValues.containsKey('ocrDocumentScanResultDetails')) {
            postProcessingFailed();
            return;
        }

        // 4) Get the pages array
        Map<String, Object> detailsWrap = 
            (Map<String, Object>) outputValues.get('ocrDocumentScanResultDetails');
        List<Object> pages = 
            (List<Object>) detailsWrap.get('ocrDocumentScanResultDetails');
        if (pages == null || pages.isEmpty()) {
            postProcessingFailed();
            return;
        }

        // 5) Build a new Identification record
        Identification__c idRec = new Identification__c();
        idRec.Application__c   = recordId;

        // 6) Your existing mapping, plus a counter
        Integer mappedCount = 0;
        for (Object pgObj : pages) {
            Map<String, Object> pageMap = (Map<String, Object>) pgObj;
            List<Object> kvps = (List<Object>) pageMap.get('keyValuePairs');
            if (kvps == null) continue;

            for (Object kvpObj : kvps) {
                Map<String, Object> pair     = (Map<String, Object>) kvpObj;
                Map<String, Object> keyMap   = (Map<String, Object>) pair.get('key');
                Map<String, Object> valueMap = (Map<String, Object>) pair.get('value');
                if (keyMap == null || valueMap == null) continue;

                String label = (String) keyMap.get('value');
                String text  = (String) valueMap.get('value');
                if (label == null || text == null) continue;

                String norm = label.replaceAll('[^a-zA-Z0-9]', '').toLowerCase();

                if (norm.contains('4bexp')) {
                    idRec.Expiration_Date__c = text;
                    mappedCount++;
                } else if (norm.contains('3dob')) {
                    idRec.Date_of_Birth__c = text;
                    mappedCount++;
                } else if (norm.contains('15sex')) {
                    idRec.Sex__c = text;
                    mappedCount++;
                } else if (norm.contains('4ddln')) {
                    idRec.Driving_License_Number__c = text;
                    mappedCount++;
                }
                // …any other fields you want to map…
            }
        }

        // 7) Stitch street & apt lines into Address__c
        List<String> addressLines = new List<String>();
        for (Object pgObj : pages) {
            Map<String,Object> pageMap = (Map<String,Object>) pgObj;
            List<Object> kvps = (List<Object>) pageMap.get('keyValuePairs');
            if (kvps == null) continue;

            for (Object kvpObj : kvps) {
                Map<String,Object> pair     = (Map<String,Object>) kvpObj;
                Map<String,Object> keyMap   = (Map<String,Object>) pair.get('key');
                Map<String,Object> valueMap = (Map<String,Object>) pair.get('value');
                if (valueMap == null) continue;

                String val = (String) valueMap.get('value');
                String rawKey = keyMap == null 
                              ? '' 
                              : ((String) keyMap.get('value')).trim().toLowerCase();

                Boolean isStreet = 
                     (val != null && val.matches('^\\d+\\s+.*'))
                  || (val != null && (
                         val.toLowerCase().contains('street') ||
                         val.toLowerCase().contains('ave')    ||
                         val.toLowerCase().contains('road')
                     ));
                Boolean isApt = rawKey.contains('apt');
                if (isStreet || isApt) {
                    addressLines.add(val);
                }
            }
        }
        if (!addressLines.isEmpty()) {
            idRec.Address__c = String.join(addressLines, ', ');
            mappedCount++;
        }

        // 8) Bad image if no fields mapped
        if (mappedCount == 0) {
            postProcessingFailed();
            return;
        }

        // 9) Insert and on DML error also post failure
        try {
            insert idRec;
        } catch (DmlException e) {
            postProcessingFailed();
        }
    }

    /**
     * Uses ConnectApi.FeedItemInput + MessageBodyInput + MentionSegmentInput
     * to post exactly:
     * Textract processing failed: ‘My_DL_Image.jpg’ uploaded by @UserName failed to process...
     */
    private void postProcessingFailed() {
        // 1) Text before mention
        ConnectApi.TextSegmentInput part1 = new ConnectApi.TextSegmentInput();
        part1.text = 'Textract processing failed: \'' + docName + '\' uploaded by ';

        // 2) @-mention the running user
        ConnectApi.MentionSegmentInput mention = new ConnectApi.MentionSegmentInput();
        mention.id = UserInfo.getUserId();

        // 3) Text after mention
        ConnectApi.TextSegmentInput part2 = new ConnectApi.TextSegmentInput();
        part2.text = ' failed to process. Please make sure a valid Drivers License is uploaded.';

        // 4) Build the message body
        ConnectApi.MessageBodyInput bodyInput = new ConnectApi.MessageBodyInput();
        bodyInput.messageSegments = new List<ConnectApi.MessageSegmentInput>{ part1, mention, part2 };

        // 5) Wrap in a FeedItemInput and post
        ConnectApi.FeedItemInput feedInput = new ConnectApi.FeedItemInput();
        feedInput.body = bodyInput;

        ConnectApi.ChatterFeeds.postFeedElement(
            /* communityId */ null,
            /* subjectId   */ recordId,
            /* feedType    */ ConnectApi.FeedElementType.FeedItem,
            /* input       */ feedInput
        );
    }
}



public class ProfitAndLossSaverJob implements Queueable {
    private String rawJson;
    private String recordId;

    public ProfitAndLossSaverJob(String rawJson, String recordId) {
        this.rawJson  = rawJson;
        this.recordId = recordId;
    }

    public void execute(QueueableContext context) {
        // 1) No payload at all
        if (String.isBlank(rawJson)) {
            postToChatter(
                'P&L failed: no data received. Please upload a valid Profit & Loss document.'
            );
            return;
        }

        // 2) Top-level array
        List<Object> wrapperList = (List<Object>) JSON.deserializeUntyped(rawJson);
        if (wrapperList.isEmpty()) {
            postToChatter(
                'P&L failed: empty response. Please upload a valid Profit & Loss document.'
            );
            return;
        }

        // 3) Drill into the first action’s outputValues
        Map<String, Object> actionResp   = (Map<String, Object>) wrapperList[0];
        Map<String, Object> outputValues = (Map<String, Object>) actionResp.get('outputValues');
        if (outputValues == null
            || !outputValues.containsKey('ocrDocumentScanResultDetails')) {
            postToChatter(
                'P&L failed: no OCR details found. Please upload a clear Profit & Loss document.'
            );
            return;
        }

        // 4) Get the pages array
        Map<String, Object> detailsWrap = 
            (Map<String, Object>) outputValues.get('ocrDocumentScanResultDetails');
        List<Object> pages = 
            (List<Object>) detailsWrap.get('ocrDocumentScanResultDetails');

        if (pages == null || pages.isEmpty()) {
            postToChatter(
                'P&L failed: no pages detected. Please upload a valid Profit & Loss document.'
            );
            return;
        }

        // 5) Build a new Profit_and_Loss__c record
        Profit_and_Loss__c pl = new Profit_and_Loss__c();
        pl.Application__c = recordId;

        // 6) Your mapping logic, plus a counter
        Integer mappedCount = 0;
        for (Object pgObj : pages) {
            Map<String, Object> pageMap = (Map<String, Object>) pgObj;
            List<Object> kvps = (List<Object>) pageMap.get('keyValuePairs');
            if (kvps == null) continue;

            for (Object kvpObj : kvps) {
                Map<String, Object> pair     = (Map<String, Object>) kvpObj;
                Map<String, Object> keyMap   = (Map<String, Object>) pair.get('key');
                Map<String, Object> valueMap = (Map<String, Object>) pair.get('value');
                if (keyMap == null || valueMap == null) continue;

                String label = (String) keyMap.get('value');
                String text  = (String) valueMap.get('value');
                if (label == null || text == null) continue;

                String norm = label.replaceAll('[^a-zA-Z0-9]', '').toLowerCase();

                if (norm.contains('borrowernames')) {
                    pl.Borrower_Name_s__c = text;
                    mappedCount++;
                } else if (norm.contains('companyname')) {
                    pl.Name = text;
                    mappedCount++;
                } else if (norm.contains('typeofbusiness')) {
                    pl.Type_of_Bussiness__c = text;
                    mappedCount++;
                } else if (norm.contains('loannumber')) {
                    pl.Loan_Number__c = text;
                    mappedCount++;
                }
                // …any other fields you care about…
            }
        }

        // 7) If nothing mapped, we treat it as a “bad document”
        if (mappedCount == 0) {
            postToChatter(
                'P&L failed: no recognizable data detected. Please upload a valid Profit & Loss document.'
            );
            return;
        }

        // 8) Insert and catch any DML problems
        try {
            insert pl;
        } catch (DmlException e) {
            String msg = e.getMessage();
            if (msg.length() > 200) {
                msg = msg.substring(0, 200) + '…';
            }
            postToChatter(
                'Could not save Profit & Loss record: ' + msg
            );
        }
    }

    /**  
     * Posts a plain-text FeedItem under the LLC_BI_Application__c record’s feed  
     */
    private void postToChatter(String body) {
        ConnectApi.ChatterFeeds.postFeedElement(
            /* communityId */ null,
            /* subjectId   */ recordId,
            /* feedType    */ ConnectApi.FeedElementType.FeedItem,
            /* text        */ body
        );
    }
}
