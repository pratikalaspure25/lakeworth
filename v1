// This method fetches the extracted text using the fetchExtractedText API
private String fetchExtractedText(String ocrDocumentScanResultId, String contentDocumentId) {
    Http http = new Http();
    HttpRequest request = new HttpRequest();

    // Salesforce REST API endpoint to check OCR status
    String checkStatusEndpoint = '/services/data/v58.0/actions/standard/fetchExtractedTextStatus';

    // Polling mechanism to check OCR status before fetching text
    String status = checkOCRStatus(ocrDocumentScanResultId);
    Integer retryCount = 0;

    while (!"SUCCESS".equals(status) && retryCount < 10) {  // Retry 10 times, can be adjusted
        System.debug('OCR status is not successful yet. Retrying...');
        retryCount++;
        System.sleep(5000);  // Wait for 5 seconds before retrying
        status = checkOCRStatus(ocrDocumentScanResultId); // Recheck the status
    }

    // If OCR is not successful after 10 retries
    if (retryCount == 10 && !"SUCCESS".equals(status)) {
        System.debug('Max retries reached or OCR processing is taking longer than expected.');
        return null;  // Return null if OCR doesn't succeed within the retries
    }

    // If OCR is successful, proceed to fetch the extracted text
    String endpointUrl = '/services/data/v58.0/actions/standard/fetchExtractedText';

    // Prepare the request body as a JSON string
    String requestBody = JSON.serialize(new Map<String, Object>{
        'inputs' => new List<Map<String, Object>>{
            new Map<String, Object> {
                'ocrDocumentScanResultId' => ocrDocumentScanResultId,  // OCR result ID obtained from the first step
                'contentDocumentId' => contentDocumentId,  // Ensure you pass the contentDocumentId as well
                'startPageIndex' => 1,  // Start from page 1
                'endPageIndex' => 20   // You can change the number of pages to extract
            }
        }
    });

    // Set up the HTTP request
    request.setEndpoint(URL.getOrgDomainUrl().toExternalForm() + endpointUrl);  // Combine Salesforce base URL with the endpoint
    request.setMethod('POST');
    request.setHeader('Content-Type', 'application/json');
    request.setHeader('Authorization', 'Bearer ' + UserInfo.getSessionId());  // Use the session ID for authorization
    request.setBody(requestBody);

    // Send the HTTP request
    HttpResponse response = http.send(request);

    // Log the response for debugging
    System.debug('Extracted Text API response: ' + response.getBody());

    // Handle the response
    if (response.getStatusCode() == 200) {
        // Deserialize the response body into a List<Object> (as per your requirement)
        List<Object> responseList = (List<Object>) JSON.deserializeUntyped(response.getBody());

        // Check if the response list is not empty
        if (responseList != null && !responseList.isEmpty()) {
            // Get the first item in the response list
            Map<String, Object> firstResult = (Map<String, Object>) responseList.get(0);

            // Check if 'outputValues' key exists and contains 'ocrDocumentScanResultDetails'
            if (firstResult.containsKey('outputValues')) {
                Map<String, Object> outputValues = (Map<String, Object>) firstResult.get('outputValues');
                if (outputValues.containsKey('ocrDocumentScanResultDetails')) {
                    // Deserialize the 'ocrDocumentScanResultDetails' as a Map
                    Map<String, Object> detailsList = (Map<String, Object>) outputValues.get('ocrDocumentScanResultDetails');

                    System.debug('Extracted Text: ' + detailsList);
                    return detailsList.toString(); // Returning the extracted text (you can further process it if needed)
                }
            }
            System.debug('No OCR document scan result details found.');
            return null;
        } else {
            System.debug('No extracted text found.');
            return null;
        }
    } else {
        System.debug('Error calling Extracted Text API, status: ' + response.getStatus() + ', body: ' + response.getBody());
        return null;
    }
}

// Helper method to check OCR status
private String checkOCRStatus(String ocrDocumentScanResultId) {
    Http http = new Http();
    HttpRequest request = new HttpRequest();

    // Salesforce REST API endpoint to check OCR status
    String endpointUrl = '/services/data/v58.0/actions/standard/fetchExtractedTextStatus';

    // Prepare the request body to check status
    String requestBody = JSON.serialize(new Map<String, Object>{
        'ocrDocumentScanResultId' => ocrDocumentScanResultId
    });

    // Set up the HTTP request
    request.setEndpoint(URL.getOrgDomainUrl().toExternalForm() + endpointUrl);
    request.setMethod('POST');
    request.setHeader('Content-Type', 'application/json');
    request.setHeader('Authorization', 'Bearer ' + UserInfo.getSessionId());
    request.setBody(requestBody);

    // Send the HTTP request and get response
    HttpResponse response = http.send(request);
    System.debug('OCR Status API response: ' + response.getBody());

    // Handle the response
    if (response.getStatusCode() == 200) {
        Map<String, Object> result = (Map<String, Object>) JSON.deserializeUntyped(response.getBody());
        String status = (String) result.get('status');
        
        return status;  // Return the current OCR status
    } else {
        System.debug('Error checking OCR status: ' + response.getStatus());
        return "Unknown";  // Return Unknown if an error occurs
    }
}
